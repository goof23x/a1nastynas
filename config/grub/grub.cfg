# A1NAS Custom GRUB Configuration
# Professional branding with multiple boot options

# Basic GRUB settings
set timeout=30
set default=0
set fallback=1

# Terminal and display settings
terminal_output console
if [ "${grub_platform}" = "efi" ]; then
    set gfxmode=auto
    set gfxpayload=keep
else
    set gfxmode=1024x768x32,1024x768x24,1024x768x16,auto
fi

# Load modules
insmod all_video
insmod gfxterm
insmod png
insmod jpeg
insmod part_gpt
insmod part_msdos
insmod iso9660
insmod loopback
insmod search
insmod search_fs_file
insmod search_fs_uuid

# Enable graphics terminal
if loadfont /boot/grub/fonts/unicode.pf2; then
    set gfxterm_font=unicode
    terminal_output gfxterm
fi

# Set background image if available
if [ -f /boot/grub/themes/a1nas/background.png ]; then
    insmod png
    background_image /boot/grub/themes/a1nas/background.png
fi

# Custom theme
if [ -f /boot/grub/themes/a1nas/theme.txt ]; then
    set theme=/boot/grub/themes/a1nas/theme.txt
fi

# Custom colors
set color_normal=cyan/black
set color_highlight=white/blue

# A1NAS ASCII Art Header
echo -e "\033[0;36m"
echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║     ▄▀█ ▄█ █▄ █ ▄▀█ █▀   █▄ █ ██▀ ▀█▀ █ █ █ █▀█ █▀█ █▄▀        ║"
echo "║     █▄█ ▀█ █▀▄█ █▄█ ▄█   █▀▄█ ██▄  █  ▀▄▀▄▀ █▄█ █▀▄ █ █        ║"
echo "║                                                                  ║"
echo "║           🚀 A1NAS - NETWORK ATTACHED STORAGE OS 🚀             ║"
echo "║                      Professional Edition                       ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo -e "\033[0m"

# Menu entries
menuentry "🚀 A1NAS OS - Live Mode (Default)" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "🔄 Loading A1NAS Live System..."
    echo "   ➤ Kernel: Loading Linux kernel..."
    linux /boot/vmlinuz boot=live components quiet splash toram live-media-path=/live
    echo "   ➤ InitRD: Loading initial ramdisk..."
    initrd /boot/initrd
    echo "   ➤ Ready! Booting A1NAS..."
}

menuentry "⚡ A1NAS OS - Performance Mode" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "⚡ Loading A1NAS Performance Mode..."
    echo "   ➤ Optimized for maximum performance"
    linux /boot/vmlinuz boot=live components toram live-media-path=/live acpi_osi=Linux pcie_aspm=off processor.max_cstate=1 intel_idle.max_cstate=0 idle=poll
    initrd /boot/initrd
}

menuentry "🔧 A1NAS OS - Debug Mode" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "🔧 Loading A1NAS Debug Mode..."
    echo "   ➤ Verbose logging enabled"
    linux /boot/vmlinuz boot=live components live-media-path=/live debug systemd.log_level=debug systemd.log_target=console console=tty0 console=ttyS0,115200n8
    initrd /boot/initrd
}

menuentry "🛡️ A1NAS OS - Safe Mode" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "🛡️ Loading A1NAS Safe Mode..."
    echo "   ➤ Minimal drivers and safe configuration"
    linux /boot/vmlinuz boot=live components quiet live-media-path=/live nomodeset acpi=off noapic nosmp
    initrd /boot/initrd
}

menuentry "💾 A1NAS OS - Persistent Storage" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "💾 Loading A1NAS with Persistent Storage..."
    echo "   ➤ Looking for persistence volume..."
    linux /boot/vmlinuz boot=live components quiet splash live-media-path=/live persistence
    initrd /boot/initrd
}

menuentry "🧰 A1NAS OS - Recovery Mode" --class a1nas --class gnu-linux --class gnu --class os {
    set gfxpayload=keep
    echo "🧰 Loading A1NAS Recovery Mode..."
    echo "   ➤ Single user mode for system recovery"
    linux /boot/vmlinuz boot=live components live-media-path=/live single init=/bin/bash
    initrd /boot/initrd
}

submenu "🔬 Advanced Options" --class submenu {
    menuentry "💻 A1NAS OS - Text Mode Only" --class a1nas {
        echo "💻 Loading A1NAS Text Mode..."
        linux /boot/vmlinuz boot=live components live-media-path=/live text systemd.unit=multi-user.target
        initrd /boot/initrd
    }
    
    menuentry "🌐 A1NAS OS - Network Boot Check" --class a1nas {
        echo "🌐 Loading A1NAS with Network Diagnostics..."
        linux /boot/vmlinuz boot=live components live-media-path=/live netboot
        initrd /boot/initrd
    }
    
    menuentry "🔍 Memory Test (Memtest86+)" --class memtest {
        echo "🔍 Starting Memory Test..."
        if [ -f /boot/memtest86+.bin ]; then
            linux16 /boot/memtest86+.bin
        else
            echo "❌ Memtest86+ not found"
            sleep 3
        fi
    }
}

submenu "🛠️ System Tools" --class submenu {
    menuentry "🔧 Hardware Detection Test" --class tool {
        echo "🔧 Loading Hardware Detection..."
        linux /boot/vmlinuz boot=live components live-media-path=/live hwdetect
        initrd /boot/initrd
    }
    
    menuentry "💽 Disk Utility Mode" --class tool {
        echo "💽 Loading Disk Utilities..."
        linux /boot/vmlinuz boot=live components live-media-path=/live disk-utility
        initrd /boot/initrd
    }
}

menuentry "🔄 Reboot System" --class reboot {
    echo "🔄 Rebooting system..."
    reboot
}

menuentry "⚡ Shutdown System" --class shutdown {
    echo "⚡ Shutting down system..."
    halt
}

# Help text
menuentry "❓ Boot Help & Information" --class help {
    echo "╔══════════════════════════════════════════════════════════════════╗"
    echo "║                        A1NAS Boot Help                          ║"
    echo "╠══════════════════════════════════════════════════════════════════╣"
    echo "║ 🚀 Live Mode:        Standard boot with full desktop            ║"
    echo "║ ⚡ Performance:      Optimized for high-performance workloads   ║"
    echo "║ 🔧 Debug Mode:       Verbose logging for troubleshooting        ║"
    echo "║ 🛡️ Safe Mode:        Minimal drivers for compatibility          ║"
    echo "║ 💾 Persistent:       Saves changes to USB/disk                  ║"
    echo "║ 🧰 Recovery:         Single-user mode for system repair         ║"
    echo "╠══════════════════════════════════════════════════════════════════╣"
    echo "║ For more information: https://github.com/yourusername/a1nas     ║"
    echo "║ Support: support@a1nas.com                                      ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    echo ""
    echo "Press any key to return to boot menu..."
    read
}

# Boot parameter explanations for advanced users
if [ "${grub_platform}" = "pc" ]; then
    # BIOS-specific settings
    set root='(cd)'
    search --no-floppy --set=root --file /boot/vmlinuz
else
    # UEFI-specific settings
    search --no-floppy --set=root --file /boot/vmlinuz
fi

# Automatic boot countdown with styled message
echo ""
echo -e "\033[1;33m⏱️  A1NAS will boot automatically in ${timeout} seconds...\033[0m"
echo -e "\033[0;36m💡 Press any key to access the boot menu\033[0m"
echo -e "\033[0;32m🚀 Welcome to A1NAS - The Future of Network Storage!\033[0m"